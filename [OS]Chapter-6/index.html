<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.arui.dev","root":"/","images":"/images","scheme":"Gemini","darkmode":"ture","version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Notion å¥½è®€ç‰ˆ  Background  å› ç‚ºæœ‰ share çš„ dataï¼Œæœƒè¢«å¤šå€‹ content å»ç”¨ä»–ï¼Œæ‰€ä»¥éœ€è¦ å°±ç®—åªæœ‰ä¸€å€‹ coreï¼Œä¹Ÿæœƒæœ‰ Concurrent çš„å•é¡Œï¼ˆå› ç‚ºæœƒæœ‰ content switchï¼‰ é‡é»å°±æ˜¯ä»–å€‘ execute çš„ order Consumer &amp; Producer Problem  ç”¨ counter å»è¨˜é‚„æœ‰å¹¾å€‹ç©ºä½ Producer 1">
<meta property="og:type" content="article">
<meta property="og:title" content="[OS] Chapter 6 â€” Process Synchronization">
<meta property="og:url" content="https://blog.arui.dev/[OS]Chapter-6/">
<meta property="og:site_name" content="ARui&#39;s Blog">
<meta property="og:description" content="Notion å¥½è®€ç‰ˆ  Background  å› ç‚ºæœ‰ share çš„ dataï¼Œæœƒè¢«å¤šå€‹ content å»ç”¨ä»–ï¼Œæ‰€ä»¥éœ€è¦ å°±ç®—åªæœ‰ä¸€å€‹ coreï¼Œä¹Ÿæœƒæœ‰ Concurrent çš„å•é¡Œï¼ˆå› ç‚ºæœƒæœ‰ content switchï¼‰ é‡é»å°±æ˜¯ä»–å€‘ execute çš„ order Consumer &amp; Producer Problem  ç”¨ counter å»è¨˜é‚„æœ‰å¹¾å€‹ç©ºä½ Producer 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%201.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%202.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%203.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%204.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%205.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%206.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%207.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%208.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%209.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2010.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2011.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2012.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2013.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2014.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2015.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2016.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2017.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2018.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2019.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2020.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2021.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2022.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2023.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2024.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2025.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2026.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2027.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2028.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2029.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2030.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2031.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2032.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2033.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2034.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2035.png">
<meta property="og:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled%2036.png">
<meta property="article:published_time" content="2022-02-01T00:06:24.000Z">
<meta property="article:modified_time" content="2022-02-01T14:18:25.755Z">
<meta property="article:author" content="ARui">
<meta property="article:tag" content="Notes">
<meta property="article:tag" content="Operating System">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.arui.dev/assets/%5BOS%5DChapter-6/Untitled.png">


<link rel="canonical" href="https://blog.arui.dev/[OS]Chapter-6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.arui.dev/[OS]Chapter-6/","path":"[OS]Chapter-6/","title":"[OS] Chapter 6 â€” Process Synchronization"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[OS] Chapter 6 â€” Process Synchronization | ARui's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ARui's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#background"><span class="nav-number">1.</span> <span class="nav-text">Background</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#race-condition"><span class="nav-number">1.1.</span> <span class="nav-text">Race Condition</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#critical-section"><span class="nav-number">2.</span> <span class="nav-text">Critical Section</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#critical-section-requirements"><span class="nav-number">2.1.</span> <span class="nav-text">Critical Section
Requirements</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#review-slide"><span class="nav-number">2.2.</span> <span class="nav-text">Review Slide</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#software-solution"><span class="nav-number">3.</span> <span class="nav-text">Software Solution</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#petersons-solution-for-two-processes"><span class="nav-number">3.1.</span> <span class="nav-text">Petersonâ€™s Solution for
Two Processes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#proof"><span class="nav-number">3.1.1.</span> <span class="nav-text">Proof</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#producerconsumer-problem"><span class="nav-number">3.2.</span> <span class="nav-text">Producer&#x2F;Consumer Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bakery-algorithm-n-processes"><span class="nav-number">3.3.</span> <span class="nav-text">Bakery Algorithm (n
processes)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#synchronization-hardware"><span class="nav-number">4.</span> <span class="nav-text">Synchronization Hardware</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#atomic-instruction"><span class="nav-number">4.1.</span> <span class="nav-text">Atomic instruction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#testandset"><span class="nav-number">4.1.1.</span> <span class="nav-text">TestAndSet()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#swap"><span class="nav-number">4.1.2.</span> <span class="nav-text">Swap()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#review-slide-2"><span class="nav-number">4.2.</span> <span class="nav-text">Review Slide (2)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#semaphores"><span class="nav-number">5.</span> <span class="nav-text">Semaphores</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#posix-semaphore"><span class="nav-number">5.1.</span> <span class="nav-text">POSIX Semaphore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#non-busy-waiting-implementation"><span class="nav-number">5.2.</span> <span class="nav-text">Non-busy waiting
Implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cooperation-synchronization"><span class="nav-number">5.3.</span> <span class="nav-text">Cooperation Synchronization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deadlocks-starvation"><span class="nav-number">5.4.</span> <span class="nav-text">Deadlocks &amp; Starvation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#review-slide-3"><span class="nav-number">5.5.</span> <span class="nav-text">Review Slide (3)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#classical-problems-of-synchronization"><span class="nav-number">6.</span> <span class="nav-text">Classical Problems of
Synchronization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#bounded-buffer-problem"><span class="nav-number">6.1.</span> <span class="nav-text">Bounded-Buffer Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#readers-writers-problem"><span class="nav-number">6.2.</span> <span class="nav-text">Readers-Writers Problem</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#first-reader-writer-algorithm"><span class="nav-number">6.2.1.</span> <span class="nav-text">First Reader-Writer
Algorithm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dining-philosophers-problem"><span class="nav-number">6.2.2.</span> <span class="nav-text">Dining-Philosophers Problem</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#monitors"><span class="nav-number">7.</span> <span class="nav-text">Monitors</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#monitor-condition-variables"><span class="nav-number">7.1.</span> <span class="nav-text">(Monitor) Condition Variables</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#thread-programming"><span class="nav-number">8.</span> <span class="nav-text">Thread Programming</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pthread-lockmutex-routines"><span class="nav-number">8.1.</span> <span class="nav-text">Pthread Lock&#x2F;Mutex Routines</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#condition-variables-cv"><span class="nav-number">8.2.</span> <span class="nav-text">Condition Variables (CV)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#threadpool-implementation"><span class="nav-number">8.3.</span> <span class="nav-text">ThreadPool Implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#synchronized-tools-in-java"><span class="nav-number">8.4.</span> <span class="nav-text">Synchronized Tools in JAVA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#review-slides-4"><span class="nav-number">8.5.</span> <span class="nav-text">Review Slides (4)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#atomic-transactions"><span class="nav-number">9.</span> <span class="nav-text">Atomic Transactions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#review-slides-5"><span class="nav-number">9.1.</span> <span class="nav-text">Review Slides (5)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#textbook-problem-set"><span class="nav-number">10.</span> <span class="nav-text">Textbook Problem Set</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ARui</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/arui-tw" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;arui-tw" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:mail@arui.dev" title="E-Mail â†’ mailto:mail@arui.dev" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/ARuiTW/" title="Facebook â†’ https:&#x2F;&#x2F;www.facebook.com&#x2F;ARuiTW&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i>Facebook</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/arui-tw/" title="LinkedIn â†’ https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;arui-tw&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.arui.dev/[OS]Chapter-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ARui">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ARui's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[OS] Chapter 6 â€” Process Synchronization | ARui's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [OS] Chapter 6 â€” Process Synchronization
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-02-01 08:06:24 / Modified: 22:18:25" itemprop="dateCreated datePublished" datetime="2022-02-01T08:06:24+08:00">2022-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Operating-System-Notes/" itemprop="url" rel="index"><span itemprop="name">Operating System Notes</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.7k</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <div class="note default"><p><a
target="_blank" rel="noopener" href="https://arui-tw.notion.site/Chapter-6-Process-Synchronization-dc2fdd2951b047f78a39377759ebe90c">Notion
å¥½è®€ç‰ˆ</a></p>
</div>
<h1 id="background">Background</h1>
<ul>
<li>å› ç‚ºæœ‰ share çš„ dataï¼Œæœƒè¢«å¤šå€‹ content å»ç”¨ä»–ï¼Œæ‰€ä»¥éœ€è¦</li>
<li>å°±ç®—åªæœ‰ä¸€å€‹ coreï¼Œä¹Ÿæœƒæœ‰ Concurrent çš„å•é¡Œï¼ˆå› ç‚ºæœƒæœ‰ content
switchï¼‰</li>
<li>é‡é»å°±æ˜¯ä»–å€‘ execute çš„ order</li>
<li>Consumer &amp; Producer Problem
<ul>
<li><p>ç”¨ counter å»è¨˜é‚„æœ‰å¹¾å€‹ç©ºä½</p></li>
<li><p>Producer</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	nextItem = <span class="built_in">getItem</span>( );</span><br><span class="line">	<span class="keyword">while</span> (counter == BUFFER_SIZE);</span><br><span class="line">	buffer[in] = nextItem;</span><br><span class="line">	in = (in + <span class="number">1</span>) % BUFFER_SIZE;</span><br><span class="line">	counter++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>Consumer</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="keyword">while</span> (counter == <span class="number">0</span>) ;</span><br><span class="line">	item = buffer[out];</span><br><span class="line">	out = (out + <span class="number">1</span>) % BUFFER_SIZE;</span><br><span class="line">	counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>ä½†æ˜¯ counter æœƒæ˜¯é€™å…©éš» thread
å…±ç”¨çš„æ±æ±ï¼Œæ‰€ä»¥æœƒå‡ºç¾ä¸ä¸€è‡´çš„å•é¡Œï¼š</p>
<ul>
<li><p><code>counter++</code></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">move ax, counter</span><br><span class="line">add  ax, <span class="number">1</span></span><br><span class="line">move counter, ax</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>counter--</code></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">move bx, counter</span><br><span class="line">sub  bx, <span class="number">1</span></span><br><span class="line">move counter, bx</span><br></pre></td></tr></table></figure></p></li>
<li><p>ä½†æ˜¯â€¦å¦‚æœæ˜¯é€™æ¨£å‘¢ï¼Ÿï¼ˆcounter initially is 5ï¼‰</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">producer: move ax, counter   <span class="comment">// ax = 5</span></span><br><span class="line">producer: add ax, <span class="number">1</span>          <span class="comment">// ax = 6</span></span><br><span class="line">context <span class="keyword">switch</span></span><br><span class="line">consumer: move bx, counter   <span class="comment">// bx = 5</span></span><br><span class="line">consumer: sub bx, <span class="number">1</span>          <span class="comment">// bx = 4</span></span><br><span class="line">context <span class="keyword">switch</span></span><br><span class="line">producer: move counter, ax   <span class="comment">// counter = 6</span></span><br><span class="line">context <span class="keyword">switch</span></span><br><span class="line">consumer: move counter, bx   <span class="comment">// counter = 4</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸éå¦‚æœä¸æ˜¯ preemptive å°±ä¸æœƒæœ‰é€™å€‹å•é¡Œäº†ã€‚</p></li>
</ul></li>
</ul></li>
</ul>
<h2 id="race-condition">Race Condition</h2>
<aside>
<p>ğŸ“– å¤šå€‹ process æ“ä½œ shared data
concurrentlyï¼Œçµæœæœƒå–æ±ºæ–¼æœ€å¾Œå®Œæˆçš„äººã€‚ï¼ˆé€™æ˜¯æè¿°ä¸€å€‹å•é¡Œé»ï¼Œæ‰€ä»¥æ˜¯å› ç‚ºæœ‰
race conditionï¼Œè¦ç”¨åŒæ­¥åŒ–è§£æ±ºï¼‰</p>
</aside>
<ul>
<li>Single processor çš„å¯ä»¥ç”¨ disable interrupt æˆ– non-preemptive CPU
ä¾†è§£æ±ºã€‚</li>
</ul>
<span id="more"></span>
<h1 id="critical-section">Critical Section</h1>
<ul>
<li><p><del>ä¸€å€‹ process ä¹‹é–“æºé€šçš„ protocol</del></p></li>
<li><p>Critical section: æœƒç”¢ç”Ÿ race condition çš„é‚£æ®µç¨‹å¼ç¢¼ã€‚</p></li>
<li><p>Mutually exclusive: æœƒæœ‰ç›¸åŒ critical section çš„
processã€‚ä»–å€‘è¦åœ¨é‚£æ®µ critical section è¢«è¿«å» serializeã€‚</p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled.png"
alt="Remainder section: å‰©ä¸‹çš„" />
<figcaption aria-hidden="true">Remainder section: å‰©ä¸‹çš„</figcaption>
</figure></li>
</ul>
<h2 id="critical-section-requirements">Critical Section
Requirements</h2>
<ol type="1">
<li>Mutual Exclusion: if process P is executing in its CS, no other
processes can be executing in their CS</li>
<li>Progress: æœ‰ process æƒ³è¦é€²å»ç©ºçš„ critical
sectionï¼Œå°±æ‡‰è©²è¦è®“ä»–é¦¬ä¸Šé€²å»ã€‚ï¼ˆæœ‰æ•ˆæ€§ï¼‰</li>
<li>Bounded Waiting: ä¸èƒ½è®“ç­‰çš„äººä¸€ç›´ç­‰ï¼Œè¦ bound ä»–çš„ waiting
timeã€‚ï¼ˆå…¬å¹³æ€§ï¼‰</li>
</ol>
<ul>
<li>2 å’Œ 3 æ˜¯å¯æ¨å–çš„</li>
</ul>
<h2 id="review-slide">Review Slide</h2>
<ul>
<li>Race condition?</li>
<li>Critical-Section (CS) problem? 4 sections?
<ul>
<li>entry, CS, exit, remainder</li>
</ul></li>
<li>3 requirements for solutions to CS problems?
<ul>
<li>mutual exclusion</li>
<li>progress</li>
<li>bounded waiting</li>
</ul></li>
</ul>
<h1 id="software-solution">Software Solution</h1>
<ul>
<li><p>Assume only 2 processes, <span class="math inline">\(P_0\)</span>
and <span class="math inline">\(P_1\)</span></p></li>
<li><p>ç”¨ <code>turn</code> æ±ºå®šè¼ªåˆ°èª°</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%201.png" /></p>
<ul>
<li>å› ç‚ºæ˜¯ç”¨ single instruction å» setï¼Œæ‰€ä»¥ä¸æœƒè¢«ä¸­æ–·è© å”±</li>
<li>Requirements
<ol type="1">
<li>Mutual Exclusion: Yes</li>
<li>Progress: <strong>Nope</strong>ï¼Œä¸ç¬¦åˆ Progress çš„æ¢ä»¶ï¼Œ å› ç‚º <span
class="math inline">\(P_0\)</span> å¯èƒ½å·²ç¶“ç¹ä¸€åœˆæƒ³ä¸Šå»äº†ï¼Œä½†æ˜¯å› ç‚º
<span class="math inline">\(P_1\)</span> é‚„æ²’é€²é CSï¼Œæ‰€ä»¥ä»–é€²ä¸å»</li>
<li>Bounded Waiting: Yesï¼Œå› ç‚ºæ˜¯ Round robin.</li>
</ol></li>
</ul></li>
</ul>
<h2 id="petersons-solution-for-two-processes">Petersonâ€™s Solution for
Two Processes</h2>
<ul>
<li><p>è·Ÿå‰›å‰›é‚£å€‹å¾ˆåƒï¼Œä½†æ˜¯å¤šäº†ä¸€å€‹ flagï¼Œç”¨ä¾†è¡¨ç¤ºä»–æ˜¯ä¸æ˜¯æƒ³è¦é€²å»
critical sectionï¼ˆTrue å°±æ˜¯ä»–æº–å‚™å¥½é€²å»äº†ï¼‰</p></li>
<li><p>å°æ–¹å¯ä»¥çœ‹åˆ°åˆ¥äººçš„ flagï¼Œä½†æ˜¯åªæœ‰è‡ªå·±å¯ä»¥æ”¹è‡ªå·±çš„</p></li>
<li><p>æ‰€ä»¥é€²å»çš„æ™‚å€™å°±æ˜¯åˆ¥äººä¸æƒ³é€²å»ï¼Œæˆ–æ˜¯ä½ æ‹¿åˆ° token äº†ï¼ˆi.e.
å°æ–¹æ²’æ‹¿åˆ° tokenï¼‰</p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%202.png"
alt="æ³¨æ„æ˜¯è¦åœ¨é€²å»å‰æŠŠ turn å€¼çµ¦å°æ–¹" />
<figcaption aria-hidden="true">æ³¨æ„æ˜¯è¦åœ¨<strong>é€²å»å‰</strong>æŠŠ turn
å€¼çµ¦å°æ–¹</figcaption>
</figure></li>
</ul>
<h3 id="proof">Proof</h3>
<ul>
<li>Mutual exclusion: ç”¨åè­‰
<ol type="1">
<li><p>å‡è¨­ä»–å€‘å¯ä»¥åŒæ™‚åœ¨è£¡é¢</p></li>
<li><p>é‚£ä¸‹é¢çš„æ¢ä»¶å°±è¦åŒæ™‚å­˜åœ¨ã€‚</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%203.png" /></p></li>
<li><p>å› ç‚ºä»–å€‘éƒ½åœ¨è£¡é¢ï¼Œæ‰€ä»¥ flag éƒ½æ˜¯ true</p></li>
<li><p>ä½†æ˜¯ turn ä¸å¯èƒ½åŒæ™‚æ˜¯ 0 ä¸” 1</p></li>
<li><p>æ‰€ä»¥ä¸å¯èƒ½åŒæ™‚é€²å»</p></li>
</ol></li>
<li>Progress
<ol type="1">
<li>å‡è¨­ <span class="math inline">\(P_0\)</span> æƒ³è¦é€²å»ï¼Œä¸” <span
class="math inline">\(P_1\)</span> ä¸æƒ³è¦é€²å»ï¼Œè¦è­‰é€™æ™‚å€™ <span
class="math inline">\(P_0\)</span> æ‡‰è©²è¦è¦å¯ä»¥é€²å» â‡’
å¥½åƒä¹Ÿä¸ç”¨è­‰ï¼Œåæ­£å°±å¯ä»¥å•Š</li>
<li>å…©å€‹éƒ½æƒ³é€²å»çš„æ™‚å€™ï¼Œé‚£å°±çœ‹
<code>turn</code>ï¼Œä¸€å®šæœ‰å…¶ä¸­ä¸€å€‹å¯ä»¥é€²å»</li>
</ol></li>
<li>Bounded Waiting
<ul>
<li>å‡è¨­ç•¶ <span class="math inline">\(P_1\)</span> æƒ³è¦é€²å»ï¼Œä½†æ˜¯ <span
class="math inline">\(P_0\)</span> åœ¨è£¡é¢ã€‚</li>
</ul>
<ol type="1">
<li><p><span class="math inline">\(P_0\)</span> ä¸€é›¢é–‹ CS å°±æŠŠ
<code>flag</code> è¨­æˆ False äº†ï¼Œæ‰€ä»¥é¦¬ä¸Šå°±è¼ªåˆ° <span
class="math inline">\(P_1\)</span> äº†</p></li>
<li><p><span class="math inline">\(P_0\)</span> å¦‚æœä¸€é›¢é–‹ CS
å°±åˆæƒ³é€²å»ï¼ˆå¯èƒ½å› ç‚ºå‰©ä¸‹çš„éƒ½æ˜¯ CPU burstï¼Œæ‰€ä»¥å°±æ²’æœ‰è¢« content switch
æ‰ï¼‰</p>
<p>â‡’ ä½†æ˜¯å› ç‚ºæœƒåœ¨æœ€ä¸€é–‹å§‹æŠŠ token çµ¦åˆ¥äººï¼Œæ‰€ä»¥æœƒè¢«è®“çµ¦åˆ¥äººä½œ</p></li>
</ol></li>
</ul>
<h2 id="producerconsumer-problem">Producer/Consumer Problem</h2>
<ul>
<li><p>å¦‚æœå…ˆé€² Consumer å°±æœƒ deadlockï¼ˆi.e. ç¨‹å¼æ²’æœ‰åœ¨å‰é€²ï¼Œä½†æ˜¯ CPU
åœ¨ç‡’ï¼‰ã€‚</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%204.png" /></p></li>
<li><p>æ­£ç¢ºä½†æ˜¯ä½æ•ˆèƒ½ã€‚</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%205.png" /></p></li>
<li><p>æ­£ç¢ºä¸”å„ªè³ªã€‚</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%206.png" /></p></li>
</ul>
<h2 id="bakery-algorithm-n-processes">Bakery Algorithm (n
processes)</h2>
<ul>
<li>åƒå»éºµåŒ…åº—</li>
</ul>
<ol type="1">
<li>åœ¨æ¯æ¬¡é€²å» CS å‰ï¼Œè¦æŠ½è™Ÿç¢¼ç‰Œ</li>
<li>è™Ÿç¢¼ç‰Œæœ€å°çš„å…ˆé€²ï¼ˆå› ç‚º counter æ˜¯ç”¨ <code>++</code>
çš„ï¼Œæ‰€ä»¥<strong>åªèƒ½</strong>ä¿è­‰æ˜¯ non-decrease order çš„ï¼Œe.g. 1, 2, 3,
3, 4, 4, 4, 5ï¼‰</li>
<li>å¦‚æœè™Ÿç¢¼ç‰Œä¸€æ¨£ï¼Œå°±æ ¹æ“š process IDï¼Œå°çš„å…ˆ</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Process i</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">	choosing[i] = <span class="literal">true</span>;  <span class="comment">// é–‹å§‹æŠ½</span></span><br><span class="line">	num[i] = <span class="built_in">max</span>(num[<span class="number">0</span>], num[<span class="number">1</span>], ..., num[n<span class="number">-1</span>]) + <span class="number">1</span>; <span class="comment">// get ticket</span></span><br><span class="line">	choosing[i] = <span class="literal">false</span>; <span class="comment">// æŠ½å®Œäº†</span></span><br><span class="line">	<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">		<span class="keyword">while</span> (choosing[j]);  <span class="comment">// ç¢ºå®šä»–æŠ½å®Œäº†æ‰å¯ä»¥æ¯”</span></span><br><span class="line">		<span class="keyword">while</span> ((num[j] != <span class="number">0</span>) &amp;&amp;     <span class="comment">// num æ˜¯ 0 å°±æ˜¯ä¸æƒ³é€²å»</span></span><br><span class="line">					 ((num[j], j) &lt; (num[i], i))); <span class="comment">// æ¯”è¼ƒæ¯ä¸€å€‹ j ç¢ºå®šæˆ‘æ˜¯æœ€å°çš„</span></span><br><span class="line">	&#125;</span><br><span class="line">		**critical section**</span><br><span class="line">	num[i] = <span class="number">0</span>;</span><br><span class="line">		**reminder section**</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>æœ€å°è™Ÿç¢¼ä¸€å®šå…ˆåš â†’ first come first serve â†’ bounded-waiting
time</li>
<li>å¦‚æœæ²’æœ‰ choosing
<ol type="1">
<li>å‡è¨­ç›®å‰æœ€å¤§æ˜¯ 5</li>
<li>P4 æŠ½çš„æ¯”è¼ƒå¿«ï¼ŒæŠ½åˆ° 6ï¼Œé€™æ™‚å€™ P1 é‚„æ˜¯ 0</li>
<li>ç„¶å¾Œ P4 æœƒé€²å» CSï¼ˆä»–é€™æ™‚å€™æœƒä»¥ç‚º P1 æ²’æœ‰è¦é€²å»ï¼Œå› ç‚ºä»–æ˜¯ 0ï¼‰</li>
<li>æ¥ä¸‹ä¾† P1 æŠ½å®Œäº†ï¼ŒæŠ½åˆ° 6ï¼Œä»–å°±å»è·Ÿ P4 æ¯”ï¼Œç™¼ç¾è·Ÿä»–ä¸€æ¨£ï¼Œä½†æ˜¯ä»–çš„ pid
æ¯”è¼ƒå°ï¼Œæ‰€ä»¥ä»–å°±é–‹é–‹å¿ƒå¿ƒçš„é€²å»äº†ã€‚ç„¶å¾Œå°±æ²’æœ‰ç„¶å¾Œäº†ã€‚(race condition
by355)</li>
</ol>
<ul>
<li>å¦‚æœæœ‰ lockingï¼ŒP4 å°±æœƒç­‰åˆ° P1 å…ˆæŠ½å®Œå†è·Ÿä»–æ¯”</li>
</ul></li>
</ul>
<h1 id="synchronization-hardware">Synchronization Hardware</h1>
<p>åªè¦ç”¨åˆ° Hardware çš„å°±ç®—æ˜¯ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„ disable interruptï¼‰</p>
<h2 id="atomic-instruction">Atomic instruction</h2>
<p>ä¸€å€‹ CPU çš„ instructionï¼Œæ‰€ä»¥ä¸€å®šæœƒä¸€æ¬¡åšå®Œã€‚</p>
<p>ä¸éœ€è¦ library çš„ supportï¼Œå…§å»ºå°±æœ‰äº†ã€‚</p>
<h3 id="testandset"><code>TestAndSet()</code></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">boolean <span class="title">TestAndSet</span> <span class="params">(<span class="type">bool</span> &amp;lock)</span> </span>&#123;</span><br><span class="line">	<span class="type">bool</span> value = lock;</span><br><span class="line">	lock = TRUE;   <span class="comment">// ä¸è«–çµæœï¼Œéƒ½æœƒé–èµ·ä¾†</span></span><br><span class="line">	<span class="keyword">return</span> value;  <span class="comment">// return çš„æ˜¯åŸæœ¬çš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%207.png" /></p>
<ul>
<li><p>Mutual exclusion: Yes</p>
<p>â‡’ å› ç‚ºåªæœ‰æ­£åœ¨ CS è£¡é¢çš„äººæŠŠä»–è¨­æˆ False æ‰å¯ä»¥æ”¾ä¸‹ä¸€å€‹é€²å»</p></li>
<li><p>Progress: Yes</p>
<p>â‡’ åªè¦æ²’äººåœ¨è£¡é¢ï¼Œæƒ³é€²å»å°±å¯ä»¥é¦¬ä¸Šé€²å»</p></li>
<li><p>Bounded-Wait: No</p>
<p>â‡’ å› ç‚ºå…ˆæ¶å…ˆè´ï¼Œæ‰€ä»¥å¯èƒ½ä¸€ç›´æ¶ä¸åˆ°</p>
<p>â‡’ P0 çš„ CS çµæŸäº†ï¼Œä½†æ˜¯ CPU burst é‚„æ²’å®Œï¼Œæ‰€ä»¥ä»–åˆæ¶åˆ°
lockï¼Œç„¶å¾Œé€²å»ä¹‹å¾Œ CPU burst çµæŸäº†ï¼Œcontent switchã€‚æ›
P1ï¼Œä½†æ˜¯ä»–è¢«æ“‹åœ¨å¤–é¢ï¼ŒCPU burst ç‡’å®Œä¹‹å¾Œéƒ½è¼ªä¸åˆ°ä»– QQï¼Œåˆå›åˆ° P0
ç¹¼çºŒã€‚</p></li>
</ul>
<h3 id="swap"><code>Swap()</code></h3>
<p>æŠŠå€¼å°èª¿ã€‚</p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%208.png"
alt="ä¸€é–‹å§‹æœƒæŠŠ key è¨­æˆ Trueï¼Œç„¶å¾Œå°±åœ¨ while è£¡é¢ä¸€ç›´æŠŠ lock è·Ÿ key äº¤æ›ã€‚å¦‚æœ lock åœ¨åˆ¥çš„åœ°æ–¹è¢«è¨­æˆ False äº†ï¼Œå°±å¯ä»¥é€²å» CS äº†ã€‚" />
<figcaption aria-hidden="true">ä¸€é–‹å§‹æœƒæŠŠ key è¨­æˆ Trueï¼Œç„¶å¾Œå°±åœ¨ while
è£¡é¢ä¸€ç›´æŠŠ lock è·Ÿ key äº¤æ›ã€‚å¦‚æœ lock åœ¨åˆ¥çš„åœ°æ–¹è¢«è¨­æˆ False
äº†ï¼Œå°±å¯ä»¥é€²å» CS äº†ã€‚</figcaption>
</figure>
<ul>
<li>ç‰¹æ€§ä¹Ÿè·Ÿå‰›å‰›ä¸€æ¨£</li>
</ul>
<h2 id="review-slide-2">Review Slide (2)</h2>
<ul>
<li>Use software solution to solve CS?
<ul>
<li>Petersonâ€™s and Bakery algorithms</li>
</ul></li>
<li>Use HW support to solve CS?
<ul>
<li><code>TestAndSet()</code>, <code>Swap()</code></li>
</ul></li>
</ul>
<h1 id="semaphores">Semaphores</h1>
<ul>
<li>Resource counting çš„å•é¡Œã€‚</li>
<li>ä¸€å€‹å€¼ indicate æƒ³è¦é€é semaphore ä¿è­·çš„è³‡æºçš„æ•¸é‡å¤šå¯¡ã€‚
<ul>
<li>If #record = 1 â†’ binary semaphore, mutex lock</li>
<li>if #record &gt; 1 â†’ counting semaphore</li>
</ul></li>
<li>ç”¨å…©å€‹ atomic operationï¼š
<ol type="1">
<li><p><code>wait</code>ï¼šæ¶è³‡æº</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wait</span>(S) &#123;</span><br><span class="line">	<span class="keyword">while</span> (S &lt;= <span class="number">0</span>); <span class="comment">// busy waiting</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç”¨çš„æ˜¯ Spinlock â†’ ç­‰å¾…é‚„æ˜¯æœƒç‡’ CPUï¼ˆå› ç‚ºä¸€ç›´åœ¨ä½œæŒ‡ä»¤ï¼‰</p></li>
<li><p><code>signal</code>ï¼šæ”¾è³‡æº</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">signal</span>(S) &#123;</span><br><span class="line">	S++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
</ol></li>
</ul>
<h2 id="posix-semaphore">POSIX Semaphore</h2>
<ul>
<li><p>ä»–æ˜¯ OS çš„ API</p></li>
<li><p>Semaphore is part of POSIX standard BUT it is not belonged to
Pthread</p>
<ul>
<li>It can be used with or <strong>without</strong> thread</li>
</ul></li>
<li><p>å› ç‚º lock å¤šæ˜¯åœ¨ threads ä¹‹é–“ï¼Œsemaphore å¤šæ˜¯åœ¨ process
ä¹‹é–“ã€‚</p></li>
<li><p>POSIX Semaphore routines:</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sem_init</span>(<span class="type">sem_t</span> *sem, <span class="type">int</span> pshared, <span class="type">unsigned</span> <span class="type">int</span> value)</span><br><span class="line"><span class="built_in">sem_wait</span>(<span class="type">sem_t</span> *sem)</span><br><span class="line"><span class="built_in">sem_post</span>(<span class="type">sem_t</span> *sem)</span><br><span class="line"><span class="built_in">sem_getvalue</span>(<span class="type">sem_t</span> *sem, <span class="type">int</span> *valptr) <span class="comment">// check</span></span><br><span class="line"><span class="built_in">sem_destroy</span>(<span class="type">sem_t</span> *sem)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Example:</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="type">sem_t</span> sem;</span><br><span class="line"><span class="built_in">sem_init</span>(&amp;sem);</span><br><span class="line"><span class="built_in">sem_wait</span>(&amp;sem);</span><br><span class="line">	<span class="comment">// critical section</span></span><br><span class="line"><span class="built_in">sem_post</span>(&amp;sem);</span><br><span class="line"><span class="built_in">sem_destroy</span>(&amp;sem);</span><br></pre></td></tr></table></figure></p></li>
<li><p>Another example</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">	<span class="built_in">wait</span>(mutex);   <span class="comment">// pthread_mutex_lock(&amp;mutex)</span></span><br><span class="line">		<span class="comment">// critical section</span></span><br><span class="line">	<span class="built_in">signal</span>(mutex); <span class="comment">// pthread_mutex_unlock(&amp;mutex)</span></span><br><span class="line">		<span class="comment">// remainder section</span></span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Progress: Yes</li>
<li>Bounded waiting: å–æ±ºæ–¼ <code>wait</code> çš„å¯¦ä½œ</li>
</ul></li>
</ul>
<h2 id="non-busy-waiting-implementation">Non-busy waiting
Implementation</h2>
<aside>
<p>âœï¸ Waiting çš„æ‡‰è©²è¦è¢« put to sleepï¼ˆæ‰€ä»¥æœ‰è¦è¦å» wake up ä»–ï¼‰</p>
</aside>
<ul>
<li><p>Semaphore is data struct with a queue ï¼ˆå¯ä»¥ç”¨å„ç¨® queue
strategyï¼‰</p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="type">int</span> value;        <span class="comment">// init to 0</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">process</span> *L;</span><br><span class="line">	<span class="comment">// â€œPCBâ€ queue </span></span><br><span class="line">&#125; semaphore;</span><br></pre></td></tr></table></figure></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%209.png" /></p></li>
<li><p><code>wait()</code> and <code>signal()</code></p>
<ul>
<li>éœ€è¦ç”¨åˆ° <code>block()</code> and <code>wakeup()</code> å…©å€‹ system
callsã€‚ï¼ˆæ˜é¡¯çš„ç¼ºé»ï¼Œéœ€è¦å¤šç”¨åˆ° system callï¼‰</li>
</ul>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">signal</span><span class="params">(semaphore S)</span> </span>&#123; </span><br><span class="line">	S.value++;</span><br><span class="line">	<span class="keyword">if</span> (S.value &lt;= <span class="number">0</span>) &#123;         <span class="comment">// æ³¨æ„æœ‰ `=`ï¼Œå› ç‚ºæˆ‘å€‘å…ˆ `++` äº† </span></span><br><span class="line">		remove a process P from S.L; </span><br><span class="line">		<span class="built_in">wakeup</span>(P);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">wait</span><span class="params">(semaphore S)</span> </span>&#123;</span><br><span class="line">	S.value--;  <span class="comment">// subtract first</span></span><br><span class="line">	<span class="keyword">if</span> (S.value &lt; <span class="number">0</span>) &#123;         <span class="comment">// æ³¨æ„æ²’æœ‰ `=`</span></span><br><span class="line">		add <span class="keyword">this</span> process to S.L; <span class="comment">// è¦å…ˆæ”¾é€²å»æ‰èƒ½å»ç¡è¦º</span></span><br><span class="line">		<span class="built_in">block</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>æ›´å¤šè¡ŒåŠ ä¸Šæ›´å¤š share dataï¼ˆé‚£äº› queueï¼‰ï¼Œæ‰€ä»¥è¦ç¢ºä¿ä»–æœ‰ atomic
çš„ç‰¹æ€§ã€‚å¯ä»¥ç”¨ï¼š</p>
<ul>
<li>Single-processor: disable interrupts</li>
<li>Multi-processor:
<ul>
<li>HW support (e.g. Test-And-Set, Swap)</li>
<li>SW solution (Petersonâ€™s solution, Bakery algorithm)</li>
</ul></li>
</ul>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%2010.png"
alt="æ³¨æ„ä¸è¦åŒ…åˆ° sleep å’Œ wakeupï¼Œä¸ç„¶æœƒ deadlockã€‚" />
<figcaption aria-hidden="true">æ³¨æ„ä¸è¦åŒ…åˆ° sleep å’Œ wakeupï¼Œä¸ç„¶æœƒ
deadlockã€‚</figcaption>
</figure></li>
<li><p>å¦‚æœç­‰å¾…æ™‚é–“çŸ­ï¼Œä¸å¦‚ç”¨ busy waitingï¼Œä¸ç„¶è¦ä¸€ç›´ call system
callã€‚</p></li>
</ul>
<h2 id="cooperation-synchronization">Cooperation Synchronization</h2>
<p>å› ç‚ºæœƒæœ‰è³‡æ–™çš„ independencyï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨é€™å€‹ä¾†è§£ã€‚</p>
<ul>
<li><p>Example:</p>
<ul>
<li><p>P1 executes S1; P2 executes S2 (S2 be executed only after S1 has
completed)</p></li>
<li><p><code>sync</code> ä¸€é–‹å§‹è¨­æˆ 0</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2011.png" /></p></li>
</ul></li>
<li><p>A More Complicated Example (DAG)</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2012.png" /></p>
<ul>
<li>(Initially, all semaphores are 0)</li>
</ul>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2013.png" /></p></li>
</ul>
<h2 id="deadlocks-starvation">Deadlocks &amp; Starvation</h2>
<ul>
<li>Deadlocks: 2 processes are waiting indefinitely for each other to
release resourcesï¼ˆç¨‹å¼ä¹‹é–“å½¼æ­¤äº’å¡ï¼‰</li>
<li>Starvation:
<ul>
<li>example: LIFO (Last In First Out) queue in semaphore process
queue</li>
<li>æœ‰äººå¯ä»¥åŸ·è¡Œåªæ˜¯è¼ªä¸åˆ°æˆ‘</li>
</ul></li>
</ul>
<h2 id="review-slide-3">Review Slide (3)</h2>
<ul>
<li>Whatâ€™s semaphore? 2 operations?</li>
<li>Whatâ€™s busy-waiting (Spinlock) semaphore?</li>
<li>Whatâ€™s non-busy-waiting (Non-Spinlock) semaphore?</li>
<li>How to ensure atomic wait &amp; signal ops?</li>
<li>Deadlock? starvation?</li>
</ul>
<h1 id="classical-problems-of-synchronization">Classical Problems of
Synchronization</h1>
<p>è§£æ±ºæ–¹æ³•å¾ˆå¤šï¼Œé‡é»æ˜¯å»å®šç¾©å•é¡Œã€‚</p>
<ul>
<li>Bounded-Buffer (Producer-Consumer) Problem</li>
<li>Reader-Writers Problem</li>
<li>Dining-Philosopher Problem</li>
</ul>
<h2 id="bounded-buffer-problem">Bounded-Buffer Problem</h2>
<p>å°±ä¸Šé¢é‚£äº›å•é¡Œã€‚</p>
<ul>
<li>A pool of <em>n</em> buffers, each capable of holding one item</li>
<li>Producer:
<ul>
<li>grab an empty buffer</li>
<li>place an item into the buffer</li>
<li>waits if no empty buffer is available</li>
</ul></li>
<li>Consumer:
<ul>
<li>grab a buffer and retracts the item</li>
<li>place the buffer back to the free pool</li>
<li>waits if all buffers are empty</li>
</ul></li>
</ul>
<h2 id="readers-writers-problem">Readers-Writers Problem</h2>
<ul>
<li>reader processes â†’ åªæœƒè®€</li>
<li>writer processes â†’ åªæœƒå¯«</li>
<li>å¦‚æœéƒ½æ˜¯ reader é‚£æ²’å·®ï¼Œåæ­£åŒæ™‚ read ä¹Ÿä¸æœƒå‡ºäº‹ã€‚ä½†æ˜¯ writer
å°±åªèƒ½ä¸€å€‹äººå¯«ï¼Œé€£ reader éƒ½ä¸èƒ½åŒæ™‚ readã€‚ï¼ˆExclusive accessï¼‰</li>
<li>Different variations involving priority
<ul>
<li><p><strong>First RW problem</strong>: no reader will be kept waiting
unless a writer is updating a shared object
ï¼ˆåªè¦ç¬¦åˆä¸Šé¢çš„åŸºæœ¬å®šç¾©å°±å¥½äº†ï¼‰</p></li>
<li><p><strong>Second RW problem</strong>: first çš„æ¢ä»¶åŠ ä¸Š writer ä¸èƒ½
starvationã€‚</p>
<p>â†’ Writer è¦æ¯”è¼ƒé«˜çš„ priority</p>
<p>â†’ once a writer is ready, no new reader may start reading</p></li>
</ul></li>
</ul>
<h3 id="first-reader-writer-algorithm">First Reader-Writer
Algorithm</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mutual exclusion for write</span></span><br><span class="line">semaphore wrt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mutual exclusion for readcount</span></span><br><span class="line">semaphore mutex=<span class="number">1</span>  <span class="comment">// ä¿è­· readcount</span></span><br><span class="line"><span class="type">int</span> readcount=<span class="number">0</span>;   <span class="comment">// æœ‰å¤šå°‘äººè¦ read</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Writer</span>() &#123; </span><br><span class="line">	<span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="built_in">wait</span>(wrt);</span><br><span class="line">			**<span class="comment">// Writer Code**</span></span><br><span class="line">		<span class="built_in">signal</span>(wrt);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reader</span>() &#123;</span><br><span class="line">	<span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="built_in">wait</span>(mutex);</span><br><span class="line">		</span><br><span class="line">		readcount++;</span><br><span class="line">		<span class="comment">// Acquire write lock if reads havenâ€™t</span></span><br><span class="line">		<span class="comment">// å…¨éƒ¨ reader å…±ç”¨ä¸€å€‹ write lock</span></span><br><span class="line">		<span class="keyword">if</span> (readcount == <span class="number">1</span>) <span class="comment">// ä»£è¡¨åŸæœ¬æ²’æœ‰äººåœ¨ read</span></span><br><span class="line">			<span class="built_in">wait</span>(wrt);        <span class="comment">// æ‰€ä»¥éœ€è¦è¦éä¾†</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">signal</span>(mutex);</span><br><span class="line"></span><br><span class="line">			**<span class="comment">// Reader Code**</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">wait</span>(mutex);</span><br><span class="line"></span><br><span class="line">		readcount--;</span><br><span class="line">		<span class="comment">// release write lock if no more reads</span></span><br><span class="line">		<span class="keyword">if</span> (readcount == <span class="number">0</span>)  <span class="comment">// ä»£è¡¨æ²’æœ‰äººè¦ read äº†</span></span><br><span class="line">			<span class="built_in">signal</span>(wrt);       <span class="comment">// å°±å¯ä»¥æ”¾æ‰äº†</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">signal</span>(mutex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Writer æœƒæœ‰ starvationï¼Œå› ç‚º reader å…±ç”¨ä¸€å€‹
lockï¼Œæ‰€ä»¥å¯ä»¥ä¸€ç›´è¼ªæµä½”è‘—</p>
<p>â‡’ Second RW problem solve it.</p></li>
</ul>
<h3 id="dining-philosophers-problem">Dining-Philosophers Problem</h3>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2014.png" /></p>
<ul>
<li>æ¯å€‹äººå·¦é‚Šè·Ÿå³é‚Šéƒ½æœ‰ä¸€æ ¹ç­·å­ï¼ˆäº”å€‹äººäº”éš»ç­·å­ï¼‰
<ul>
<li>åƒé£¯éœ€è¦å…©éš»ç­·å­</li>
<li>ä¸€éš»ç­·å­åªèƒ½ä¸€å€‹äººæ‹¿</li>
<li>åƒå®Œå°±è¦æŠŠç­·å­æ”¾ä¸‹</li>
</ul></li>
<li>Deadlock problem
<ul>
<li>æ¯å€‹äººæ‹¿å·¦é‚Šçš„ç­·å­ç›´åˆ°åƒå®Œé£¯ â†’ å¡æ­»</li>
</ul></li>
<li>Starvation problem
<ul>
<li>ä¸èƒ½è®“äººä¸€ç›´æ‹¿ï¼Œä¸€ç›´åƒ</li>
</ul></li>
</ul>
<h1 id="monitors">Monitors</h1>
<aside>
<p>ğŸ’¡ å‹•æ©Ÿï¼šå› ç‚ºå‰é¢å¾ˆé›£ï¼Œè¦åœ¨å°çš„åœ°æ–¹ç”¨å°çš„æ±è¥¿ï¼Œä¸èƒ½å¤šï¼Œä¸èƒ½å°‘ã€‚</p>
</aside>
<ul>
<li><p>ç›®çš„æ˜¯è¦æ›´æŠ½è±¡åŒ–ï¼ˆä»–æ˜¯åœ¨ language levelï¼‰</p></li>
<li><p>è·Ÿ OO å¾ˆåƒ</p></li>
<li><p>åƒæ˜¯ç”±ä¸€å€‹ class å®šç¾©çš„æ±è¥¿ï¼šæœ‰è‡ªå·±çš„ methodsã€variablesã€private
variablesã€‚</p></li>
<li><p>ï¼ˆPrivate variables åªèƒ½ç”±è‡ªå·±çš„ methods æ“ä½œï¼‰</p></li>
<li><p>å’Œ OO ä¸åŒçš„æ˜¯ä»–æœƒç¢ºä¿ä»–çš„ process åªæœƒæœ‰ä¸€å€‹åœ¨
<strong>active</strong> (running) çš„ç‹€æ…‹</p></li>
<li><p>Schematic View ****</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2015.png" /></p>
<ul>
<li>Shared data â†’ private variable</li>
<li>Operations â†’ methods</li>
<li>Initialization code â†’ constructor</li>
<li>Entry queue â†’ æƒ³è¦ç”¨ monitors çš„å‚¢ä¼™</li>
</ul></li>
</ul>
<h2 id="monitor-condition-variables">(Monitor) Condition Variables</h2>
<ul>
<li><p>ä»–æ˜¯ä¸€å€‹ç¨ç«‹çš„åŒæ­¥åŒ– toolï¼Œè·Ÿ monitor æ²’é—œä¿‚</p></li>
<li><p>Event driven</p></li>
<li><p>To allow a process to wait <strong>within</strong> the monitor, a
condition variable must be declared, as</p>
<p><code>condition x, y;</code></p></li>
<li><p>Can be used with <code>wait()</code> and <code>signal()</code>
ï¼ˆä½†æ˜¯è·Ÿä¸Šé¢çš„é‚£äº›æ¯«ç„¡é—œä¿‚ï¼Œè«‹ä¸è¦ææ··ï¼Œå®šç¾©å®Œå…¨ä¸åŒï¼‰</p>
<ul>
<li><p><code>x.wait()</code></p>
<p>æœ‰ä¸€å€‹ event queueï¼Œæ‰€ä»¥é€™åƒæ˜¯ enqueueã€‚ï¼ˆä¸Šé¢çš„é‚£å€‹æ˜¯
countingï¼‰</p></li>
<li><p><code>x.signal()</code></p>
<p>åƒæ˜¯ dequeueï¼ŒæŠŠè£¡é¢çš„ process
å«é†’å»å·¥ä½œã€‚å¦‚æœè£¡é¢æ²’æœ‰æ±è¥¿ï¼Œå°±å•¥éƒ½ä¸æœƒç™¼ç”Ÿã€‚ï¼ˆå¦‚æœæ˜¯
semaphoreï¼Œå€¼æœƒç¹¼çºŒåŠ ä¸Šå»ï¼‰</p></li>
</ul></li>
</ul>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2016.png" /></p>
<ul>
<li><p>Dining Philosophers Example</p>
<ul>
<li>Thinking â€” æ ¹æœ¬æ²’è¦åƒ</li>
<li>å‡è¨­å¤§å®¶éƒ½æ˜¯çœ‹å¾—åˆ°å½¼æ­¤çš„ç‹€æ…‹çš„ï¼ˆi.e. æœ‰ Global informationï¼‰</li>
</ul>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">monitor dp &#123;</span><br><span class="line">	<span class="keyword">enum</span> &#123;thinking, hungry, eating&#125; state[<span class="number">5</span>]; <span class="comment">// current state</span></span><br><span class="line">	condition self[<span class="number">5</span>]; <span class="comment">// delay eating if canâ€™t obtain chopsticks</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">pickup</span> <span class="params">(<span class="type">int</span> i)</span>    <span class="comment">// pickup chopsticks</span></span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">putdown</span> <span class="params">(<span class="type">int</span> i)</span>   <span class="comment">// putdown chopsticks</span></span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">test</span> <span class="params">(<span class="type">int</span> i)</span>      <span class="comment">// try to eat</span></span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) </span><br><span class="line">			state[i] = thinking;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="type">void</span> <span class="title">pickup</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">	state[i] = hungry;</span><br><span class="line">	<span class="built_in">test</span>(i);               <span class="comment">// try to eat (to prevent deadlock)</span></span><br><span class="line">	<span class="keyword">if</span> (state[i] != eating)  <span class="comment">// æ²’æˆåŠŸåƒåˆ°</span></span><br><span class="line">		self[i].<span class="built_in">wait</span>();        <span class="comment">// wait to eat</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">putdown</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">  state[i] = thinking;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if neighbors are waiting to eat</span></span><br><span class="line">	<span class="comment">// å«ä»–å€‘èµ·ä¾†åƒé£¯</span></span><br><span class="line">	<span class="built_in">test</span>((i+<span class="number">4</span>) % <span class="number">5</span>);</span><br><span class="line">	<span class="built_in">test</span>((i+<span class="number">1</span>) % <span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((state[(i + <span class="number">4</span>) % <span class="number">5</span>] != eating) </span><br><span class="line">		&amp;&amp; (state[(i + <span class="number">1</span>) % <span class="number">5</span>] != eating) <span class="comment">// å·¦é‚Šå’Œå³é‚Šæœ‰æ²’æœ‰åœ¨åƒ</span></span><br><span class="line">		&amp;&amp; (state[i] == hungry)) &#123;        <span class="comment">// å’Œæˆ‘æƒ³ä¸æƒ³åƒ</span></span><br><span class="line">		<span class="comment">// No neighbors are eating and Pi is hungry</span></span><br><span class="line">		state[i] = eating;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// æŠŠä»–è‡ªå·±å«èµ·ï¼ˆå¦‚æœæ˜¯ pickup call çš„ï¼Œé€™æ˜¯æ²’æœ‰ç”¨çš„</span></span><br><span class="line">		<span class="comment">// ä½†æ˜¯å¦‚æœæ˜¯ putdown call çš„ï¼Œé‚£å°±æœƒæ–é†’ç¡è‘—çš„ï¼‰</span></span><br><span class="line">		self[i].<span class="built_in">signal</span>(); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>An illustration</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2017.png" /></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2018.png" /></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2019.png" /></p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%2020.png"
alt="P2 test å¤±æ•—ï¼Œæ‰€ä»¥å» waiting" />
<figcaption aria-hidden="true">P2 test å¤±æ•—ï¼Œæ‰€ä»¥å» waiting</figcaption>
</figure>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2021.png" /></p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%2022.png"
alt="P2 è¢«å«é†’äº†" />
<figcaption aria-hidden="true">P2 è¢«å«é†’äº†</figcaption>
</figure>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2023.png" /></p></li>
</ul></li>
</ul>
<h1 id="thread-programming">Thread Programming</h1>
<p>ï¼ˆè€ƒè©¦æ¯”è¼ƒä¸æœƒè€ƒï¼‰</p>
<h2 id="pthread-lockmutex-routines">Pthread Lock/Mutex Routines</h2>
<p>To use mutex:</p>
<ul>
<li>Declared as of type <code>pthread_mutex_t</code></li>
<li>Initialized with <code>pthread_mutex_init()</code></li>
<li>Destroyed with <code>pthread_mutex_destroy()</code></li>
<li>Use <code>pthread_mutex_lock()</code> and
<code>pthread_mutex_unlock()</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> â€œpthread.hâ€</span></span><br><span class="line">pthread_mutex mutex;</span><br><span class="line"><span class="built_in">pthread_mutex_init</span> (&amp;mutex, <span class="literal">NULL</span>);  <span class="comment">// NULL -&gt; optional configuration</span></span><br><span class="line"><span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line">	**<span class="comment">// Critical Section**</span></span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line"><span class="built_in">pthread_mutex_destroy</span>(&amp;mutex);</span><br></pre></td></tr></table></figure>
<h2 id="condition-variables-cv">Condition Variables (CV)</h2>
<p>è·Ÿä¸Šé¢çš„ä¸€æ¨£ã€‚</p>
<ul>
<li><p>In Pthread, CV type is a <code>pthread_cond_t</code></p>
<ul>
<li>Use <code>pthread_cond_init()</code> ****to initialize</li>
<li><code>pthread_cond_wait (&amp;theCV, &amp;somelock)</code></li>
<li><code>pthread_cond_signal (&amp;theCV)</code></li>
<li><code>pthread_cond_broadcast (&amp;theCV)</code> â†’ æŠŠ queue
è£¡é¢å…¨éƒ¨çš„ thread éƒ½å«é†’ï¼ˆi.e. å°ä»–å€‘å…¨éƒ¨ä½œ <code>signal</code>ï¼‰</li>
</ul></li>
<li><p>Example</p>
<ul>
<li>ä¸€å€‹ thread åœ¨ x = 0 çš„æ™‚å€™åšäº‹</li>
<li>å¦ä¸€å€‹è² è²¬ x--</li>
</ul>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2024.png" /></p>
<ul>
<li><p>ä¸€å®šè¦æŠŠ wait å’Œ signal åœ¨ mutex è¢« lock çš„æ™‚å€™æ‰èƒ½ç”¨ï¼ˆä¸ç„¶é€£
code éƒ½ä¸æœƒè·‘ï¼‰</p>
<ol type="1">
<li>å› ç‚º call wait å’Œ signal çš„æ™‚å€™ï¼Œå¤§å¤šæœƒå’Œå…¶ä»– conditional variable
æœ‰ç›¸ä¾æ€§ï¼ˆIn this case: <code>x</code>ï¼‰ï¼Œæ‰€ä»¥ lock
èµ·ä¾†æ‰æ˜¯åˆç†çš„ã€‚</li>
<li>è¦ç¢ºä¿ <code>cond</code> ä¸æœƒæœ‰ concurrent write çš„å•é¡Œã€‚</li>
</ol>
<p>â‡’ æ‰€ä»¥è‡³å°‘è¦åŒ…åˆ°ä»–æœ¬èº«å’Œä»–çš„è§¸ç™¼æ¢ä»¶ã€‚</p></li>
<li><p>What really happens...</p>
<ol type="1">
<li><p><code>action</code>: Lock <code>mutex</code></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2025.png" /></p></li>
<li><p><code>action</code> call <code>wait</code>, put thread into sleep
and <strong>release the lock</strong>. â‡’ å› ç‚º <code>wait</code> æœƒç›´æ¥
release <code>mutex</code> ï¼ˆæ‰€ä»¥ä¸æ˜¯ä¸‹é¢é‚£è¡Œåšçš„ï¼Œæ˜¯ <code>wait</code>
å°±ç›´æ¥ release æ‰äº†ï¼ï¼‰</p>
<p><code>counter</code> lock <code>mutex</code></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2026.png" /></p></li>
<li><p><code>counter</code> go into CS and call <code>signal</code>.</p>
<p><code>action</code> is waked up, but thread is locked.
ï¼ˆ<code>unlock</code> æœƒå…ˆå‘¼å« <code>lock</code>
ç¢ºå®šå¯ä»¥è·‘ï¼Œä½†é¡¯ç„¶ä¸è¡Œï¼Œå› ç‚º lock é‚„åœ¨ counter é‚£é‚Š ï¼‰</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2027.png" /></p></li>
<li><p><code>counter</code> call unlock.</p>
<p><code>action</code> Re-acquire lock and resume execution</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2028.png" /></p></li>
<li><p><code>action</code> release lock</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2029.png" /></p></li>
</ol>
<ul>
<li>å¦ä¸€å€‹æˆ‘å€‘ä¹‹æ‰€ä»¥è¦ç”¨ lock åŒ…ä½çš„åŸå› ã€‚</li>
</ul></li>
</ul></li>
</ul>
<h2 id="threadpool-implementation">ThreadPool Implementation</h2>
<ul>
<li><p>Task structure</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2030.png" /></p>
<ul>
<li>å­˜ function pointer è·Ÿ argument</li>
</ul></li>
<li><p>ThreadPool structure</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2031.png" /></p>
<ul>
<li><code>thread_count</code> â€” ç´€éŒ„ä¸€å…±æœ‰å¤šå°‘ threads</li>
<li><code>*thread</code> â€” threadPool</li>
<li><code>head</code> â€” <code>*queue</code> çš„ head</li>
<li><code>tail</code> â€” <code>*queue</code> çš„ tail</li>
<li><code>shutdown</code> â€” threadPool æ˜¯ä¸æ˜¯è¦çµæŸæ‰äº†ï¼ˆæ±ºå®šè¦ä¸è¦
break while loopï¼‰</li>
</ul></li>
<li><p>Allocate thread and task queue</p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2032.png" /></p></li>
<li><p>Implement</p>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%2033.png"
alt="æ³¨æ„æœ‰å€‹ mutex_lock ä¹Ÿæœƒå»æª¢æŸ¥ count æ˜¯ä¸æ˜¯ 0ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ç›®å‰æ²’æœ‰å·¥ä½œï¼Œå…ˆç¡è¦ºï¼ˆnotify is our condition variableï¼‰" />
<figcaption aria-hidden="true">æ³¨æ„æœ‰å€‹ <code>mutex_lock</code>
ä¹Ÿæœƒå»æª¢æŸ¥ <code>count</code> æ˜¯ä¸æ˜¯
0ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ç›®å‰æ²’æœ‰å·¥ä½œï¼Œå…ˆç¡è¦ºï¼ˆnotify is our condition
variableï¼‰</figcaption>
</figure>
<figure>
<img src="/assets/%5BOS%5DChapter-6/Untitled%2034.png"
alt="æœ‰äº‹æƒ…åšäº†ï¼Œæˆ–æ˜¯è¢« wake up èµ·ä¾†äº†ï¼Œå°±å¯ä»¥åšäº‹äº†ã€‚ æœ€å¾Œæ˜¯ call function pointerã€‚ï¼ˆæ³¨æ„æ˜¯è¦æ”¾åœ¨ CS å¤–é¢ï¼Œé€™æ¨£æ‰æœ‰å¹³è¡Œåº¦ï¼‰" />
<figcaption aria-hidden="true">æœ‰äº‹æƒ…åšäº†ï¼Œæˆ–æ˜¯è¢« wake up
èµ·ä¾†äº†ï¼Œå°±å¯ä»¥åšäº‹äº†ã€‚ æœ€å¾Œæ˜¯ call function pointerã€‚ï¼ˆæ³¨æ„æ˜¯è¦æ”¾åœ¨ CS
å¤–é¢ï¼Œé€™æ¨£æ‰æœ‰å¹³è¡Œåº¦ï¼‰</figcaption>
</figure></li>
</ul>
<h2 id="synchronized-tools-in-java">Synchronized Tools in JAVA</h2>
<ul>
<li><p>Synchronized Methods (Monitor)</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedCounter</span> &#123; </span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123; c++; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> &#123; c--; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">value</span><span class="params">()</span> &#123; <span class="keyword">return</span> c; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åŠ ä¸Š synchronized å°±å¯ä»¥ä¿è­‰åªæœ‰ä¸€å€‹æ‰æ“ä½œã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°æœ‰å‹•åˆ°
<code>c</code> çš„éƒ½æœ‰åŠ ã€‚å¦‚æœæ²’æœ‰å‹•åˆ° share data
çš„ï¼Œå¯ä»¥ä¸ç”¨åŠ ï¼Œå¢åŠ å¹³è¡Œåº¦ã€‚</p></li>
<li><p>Synchronized Statement (Mutex Lock)</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(p1)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// statement without locking requirement</span></span><br><span class="line">		p1.display(s1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="review-slides-4">Review Slides (4)</h2>
<ul>
<li>Bounded-buffer problem?</li>
<li>Reader-Writer problem?</li>
<li>Dining Philosopher problem?</li>
<li>What is monitor and why need monitor?</li>
</ul>
<h1 id="atomic-transactions">Atomic Transactions</h1>
<p>ï¼ˆè€ƒè©¦ä¸å¤ªæœƒæï¼‰</p>
<ul>
<li>System Model
<ul>
<li>Transaction: ä¸€ç³»åˆ—çš„ operation</li>
<li>Atomic Transaction: éœ€è¦ä¸€æ¬¡å®Œæˆ transactionï¼Œall or nothing</li>
<li>DB å¾ˆå®¹æ˜“éœ€è¦</li>
</ul></li>
<li>File I/O Example
<ul>
<li>Transaction æ˜¯ä¸€é€£ä¸²çš„ read and write</li>
<li>åƒæ˜¯ version control çš„å·¥å…·ï¼Œéœ€è¦æœ‰ commit
ï¼ˆæˆåŠŸï¼‰ã€abortï¼ˆå¤±æ•—ï¼‰ã€rolled backï¼ˆå¤±æ•—å¾Œè¦ undoï¼‰</li>
<li>æ‰€ä»¥é‡é»æ˜¯è¦æœ‰ log
<ul>
<li>å› ç‚ºæœ‰ log æ‰èƒ½å›æ¨é‡å»º</li>
<li>ä¹Ÿå«åš checkpoint</li>
<li>å­˜åœ¨ secondary storage</li>
</ul></li>
<li>ä¹Ÿæœƒæœ‰ checkpoints
<ul>
<li>é‚„åŸé»ï¼Œä¸Šä¸€å€‹ commit çš„é»</li>
<li>èªªä¸å®šæœƒç›´æ¥ä¸ undoï¼Œç„¶å¾Œ apply checkpoint</li>
</ul></li>
</ul></li>
</ul>
<h2 id="review-slides-5">Review Slides (5)</h2>
<ul>
<li>What is atomic transaction?</li>
<li>Purpose of commit, abort, rolled-back?</li>
<li>How to use log and checkpoints?</li>
</ul>
<h1 id="textbook-problem-set">Textbook Problem Set</h1>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2035.png" /></p>
<p><img src="/assets/%5BOS%5DChapter-6/Untitled%2036.png" /></p>
<div class="note warning"><p>æ­¤ç­†è¨˜ç‚ºæ¸…è¯å¤§å­¸å‘¨å¿—é æ•™æˆä½œæ¥­ç³»çµ±ä¹‹èª²å ‚ç­†è¨˜ï¼Œæ‰€æœ‰å…§å®¹åŠåœ–ç‰‡çš†å–ææ–¼èª²å ‚å…§å®¹ã€‚<br />
å¦‚å…§å®¹æœ‰èª¤ï¼Œæ­¡è¿ä¾†ä¿¡ <a
href="mailto:mail@arui.dev">mail@arui.dev</a>ã€‚</p>
</div>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>ARui
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://blog.arui.dev/[OS]Chapter-6/" title="[OS] Chapter 6 â€” Process Synchronization">https://blog.arui.dev/[OS]Chapter-6/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Notes/" rel="tag"># Notes</a>
              <a href="/tags/Operating-System/" rel="tag"># Operating System</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%5BOS%5DChapter-5/" rel="prev" title="[OS] Chapter 5 â€” Process Scheduling">
                  <i class="fa fa-chevron-left"></i> [OS] Chapter 5 â€” Process Scheduling
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%5BOS%5DChapter-7/" rel="next" title="[OS] Chapter 7 â€” Deadlocks">
                  [OS] Chapter 7 â€” Deadlocks <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-coffee"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ARui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
